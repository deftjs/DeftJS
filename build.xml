<project name="DeftJS" default="build">
	
	<property file="build.properties" />
	
	<target name="clean" description="Remove artifacts in build directory from previous builds.">
		<delete dir="build" />
	</target>
	
	<target name="init" description="Initialize build directory.">
		<mkdir dir="build" />
	</target>
	
	<target name="build" depends="init" description="Builds debug and deployment versions of the framework.">
		
		<echo message="Compiling CoffeeScript..." />
		<exec dir="src" executable="coffee">
			<arg line="-cb -o js coffee" />
		</exec>
		
		<echo message="Concatenating JavaScript files..." />
		<concat destfile="build/${deftjs.filename.debug}" encoding="UTF-8" outputencoding="UTF-8">
			<header>${deftjs.copyright.notice}</header>
			<filterchain>
				<linecontainsregexp negate="true">
					<regexp pattern="// Generated by CoffeeScript*"/>
				</linecontainsregexp>
			</filterchain>
			<filelist dir="src/js">
				<!-- NOTE: Order is important - driven by class dependencies. -->
				<file name="Deft/log/Logger.js" />
				<file name="Deft/util/Function.js" />
				<file name="Deft/event/LiveEventListener.js" />
				<file name="Deft/event/LiveEventBus.js" />
				<file name="Deft/ioc/DependencyProvider.js" />
				<file name="Deft/ioc/Injector.js" />
				<file name="Deft/mixin/Injectable.js" />
				<file name="Deft/mvc/ComponentSelectorListener.js" />
				<file name="Deft/mvc/ComponentSelector.js" />
				<file name="Deft/mvc/ViewController.js" />
				<file name="Deft/mixin/Controllable.js" />
				<file name="Deft/promise/Deferred.js" />
				<file name="Deft/promise/Promise.js" />
			</filelist>
		</concat>
		
		<echo message="Minifying concatenated JavaScript file..." />
		<exec dir="build" executable="yuicompressor">
			<arg line="${deftjs.filename.debug} -o ${deftjs.filename.deploy} --charset utf-8" />
		</exec>
		
		<echo message="Done." />
		
	</target>
	
</project>